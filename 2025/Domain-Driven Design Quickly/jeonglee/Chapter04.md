## 4장: 깊은 통찰을 향한 리팩터링

### 지속적인 리팩터링

> 만약 모델 없이 설계한다면, 우리가 만든 소프트웨어는 지원해야 할 도메인에 전혀 부합하지 않을 것이다.

리팩터링의 궁극적인 목표는 코드를 나쁘지 않게, 다시 말해 더 낫게 만드는 것이다. 이때, 자동화 테스트를 하면 수정 작업이 기존 기능의 어떤 것도 망치지 않았음을 확신할 수 있다. 현대에는 이런 리팩터링을 위한 도구 IDE가 많이 발전되기도 했으며 관련된 패턴도 있다.

코드적인 리팩터링도 있지만 도메인과 그 모델에 관련된 또 다른 유형의 리팩터링이 있다. **때로는 도메인에 대한 새로운 통찰이 생기고 어떤 것들은 점점 명확해지며, 둘 간의 관계가 발전되기도 한다.** 이러한 것들은 모두 리팩터링을 통해 설계에 반영되어야 한다.

코드가 진정한 모델의 실체를 표현하는 순간은 코드를 읽었을 때 그 코드가 무슨 일을 하고 있는지 직관적으로 이해할 수 있을 때이다.

모델링에 대해서 가장 먼저 배운 것은 비즈니스 명세를 읽고 명사와 동사를 찾는 것이다. **명사는 클래스로, 동사는 메서드로 변환된다. 이것은 심한 단순화이며 결국은 편합한 모델을 만들어낼 뿐이다.** 모든 모델은 초기에는 깊이가 얕을 수밖에 없으나 모델이 점점 깊은 통찰을 가지도록 개선해야 한다.

> 설계는 유연해야 한다. 유연하지 못한 설계는 리팩터링을 막는다.

유연성을 생각하지 않고 만들어진 코드로는 일해 나가기가 어렵다. 변경이 필요할 때마다 코드와 싸워야 하고, 이 코드를 개선하는데 많은 시간을 소모할 것이기 때문이다.

피상적인 것은 버리고 본질적인 것만 표현한 모델이 깊이 있는 모델이다. 이런 모델은 소프트웨어 개발자와 도메인 전문가의 생각과 일치되고 전문가의 미묘한 고민을 표헌하며 실용적인 설계를 이끌어낸다. 이러한 모델이 정교한 도메인 모델이다. 이를 위해선 지속적인 리팩터링이 필요하다.

### 핵심 개념 드러내기

리팩터링은 작은 단계로 나누어 진행되며, 그 결과 또한 작은 개선의 연속으로 나타난다. 수많은 작은 변경이 결국 설계에는 아주 미미한 가치를 제공하는 경우도 많고, 소규모의 변경이 큰 차이를 초래하는 경우도 있다. 후자가 바로 **도약**이다.

**우리는 다듬어지지 않고 피상적인 모델에서부터 시작한다. 조금씩 다듬어 나가고 도메인과 관련된 깊은 지식과 이해관계에 대한 더 나은 인식을 바탕으로 삼아 설계해 나간다. 우리는 새로운 개념과 추상화를 추가한다. 이제 설계는 개선되었고, 개선은 각각 설계를 조금 더 명확하게 한다. 이로써 도약을 위한 전제가 만들어진다.**

*도약의 경우는 코드를 작성하다 보면 나오는 결과로 DDD가 아니더라도 자주 발생한다고 생각한다. 도약의 가능성이 오히려 적어야 더 좋은 설계가 아닐까?*

도약으로 이어지는 암시적 개념은 그대로 두어선 안되고 그것이 도메인 개념이라면 모델과 설계에 반영해야 한다. *앞서 비행 시뮬레이션의 예로 이를 구체화하다 보니 비행기의 도착을 관리하는 직원의 존재가 드러났다. 같은..?*

명시적인 것을 만들어 낼 때 유용한 추가 개념은 제약 조건, 처리, 명세다. 제약 조건은 불변식을 표한하는 간단한 방법이다. 객체의 데이터에 무슨 일이 일어나든 불변식은 지켜져야 한다.

*서비스가 필요한 경우에는 전략패턴으로 이어진다는 흐름이 좋다.*

- 암시적 개념을 인지하는 방법
  - 언어를 주의 깊게 듣는 것
    - 유비쿼터스 언어가 필요한 이유과 같이 일부 정보가 언어의 차이에 의해 누락되거나 잘못 전달될 가능성이 있기에 암시적 개념을 인지하기 위해선 언어를 주의 깊게 들어야 한다.
  - 누락된 개념이 없는지 찾기 위해 노력하자
    - 설계의 어떤 부분은 분명하지 않은 경우도 있다. *전문가의 영역에서 벗어나는 경우* 무엇인가 누락되어 있는 경우가 종종 있기에 이를 위해 다른 어떤 객체가 그 자리를 차지하게 되면서 필요없는 역할과 책임을 지니게 된다 이는 결국 객체가 비대하게 되며 설계의 명료성이 떨어지는 결과를 가져온다. *일종의 갓 객체가 만들어지는 상황*
  - 상충되는 것들을 조화시키는 시도를 하자
    - 지식 체계를 만들 때는 모순에 부딪히기도 한다. 도메인 전문가가 말하는 것이 다른 결정을 유지하는 데 배치되는 것처럼보일 수 있다. 요구사항이 다른 요구사항에 상충되는 것 같기도 하다. 그러나 상충되는 것의 일부는 실제로 상충되는 것이 아니며, 같은 사물을 바라보는 관점의 차이거나 단순히 설명의 부족일 수 있다.
  - 해당 도메인의 문헌을 활용하자
    - 해당 도메인에 대한 정보를 담고 있는 책을 활용하여 도메인에 대한 깊이 있는 관점을 얻을 수 있다.
  - 명세를 활용하라.
    - 명세는 객체가 어떠한 요구를 만족하였느지 또는 어떠한 목적에 비추어 준비가 되었느지 살펴보기 위해 객체를 테스트하는 용도로 사용된다.
