# ch05. 동시성

## 논의
동시성 제어 실패 및 수정 사례가 있으면 공유하면 좋을 것 같습니다.

## 내용
- 오프라인 동시성: 여러 DB 트랜잭션에 걸쳐 조작되는 데이터에 대한 동시성 제어
- 동시성 문제
	- 손실된 업데이트
	- 일관성 없는 읽기
	- 동시 작업은 정확성과 활동성 모두 충족해야함
- 실행 컨텍스트
	- 외부 세계와 상호작용하는 관점에서 중요한 두 가지 컨텍스트
		- 요청(request)
			- 외부 세계로부터의 단일 호출
			- 대부분 서버 영역에서 수행되며 클라이언트는 응답을 기다림
		- 세션(session)
			- 클라이언트와 서버 간에 오랫동안 실행되는 상호작용
			- 한 요청만 포함할 수도 있지만 일반적으로 하나의 일관된 논리적 흐름으로 생각하는 일련의 요청이 더 많음
		- 클라이언트와의 HTTP 세션이나 다양한 DB 세션을 포함한 다중 세션을 처리하는 경우가 많음
	- 운영체제와 관련된 두가지 중요한 용어
		- 프로세스(process)
			- 사용하는 내부 데이터에 대한 다단계 격리를 제공하는 대규모 실행 컨텍스트
		- 쓰레드(thread)
			- 한 프로세스 안에서 여러 요청을 지원
			- 일반적으로 메모리를 공유하므로 동시성 문제 유발 
			- 일부 환경에서는 메모리를 공유하지 않는 격리된 스레드를 만들 수 있음
	- 트랜잭션
		- 여러 요청을 하나로 묶어 단일 요청인 것 처럼 처리
		- 종류
			- 시스템 트랜잭션: DB로 수행
			- 비즈니스 트랜잭션: 사용자에게 애플리케이션으로 수행
- 격리와 불변성
	- 격리: 오류 발생 가능성을 낮추는 필수 기법
	- 불변성: 동시성 문제는 공유 데이터가 수정될 수 있을 때만 발생함
- 낙관적 동시성 제어와 비관적 동시성 제어
	- 낙관적 잠금(optimistic lock)
		- 충돌 감지
		- 변경 내용이 충돌하면 이를 수동으로 해결
		- 깃의 머지
	- 비관적 잠금(pessimistic lock)
		- 충돌 예방
		- 파일을 체크하면 다른 사용자는 편집 불가능
		- 엑셀 프로그램
- 일관성 없는 읽기 예방
	- 비관적 잠금
		- 읽기 잠금과 쓰기 잠금으로 해결
	- 낙관적 잠금
		- 읽은 모든 데이터의 버전 표식
	- 임시 읽기
- 교착 상태 해결
	- 해결법
		- 교착상태 감지 후 희생자 한명 선택해 잠금과 작업을 손실시킴
		- 잠금에 시간 제한을 두고 시간이 초과하면 잠금과 작업을 손실시킴
	- 예방법
		- 작업 시작시 필요한 잠금을 모두 얻게하고 추가 잠금획득은 막기
- 트랜잭션
	- ACID
	- 트랜잭션 리소스
		- 트랜잭션으로 동시성을 제어할 수 있는 모든 대상
		- 긴 트랜잭션(long transaction)
			- 트랜잭션은 일반적으로 처리량 극대화를 위해 짧게 유지하도록 설계
			- 여러 요청에 걸친 트랜잭션을 긴 트랜잭션이라고 함
		- 요청 트랜잭션(request transaction)
			- 요청이 시작될 때 트랜잭션 시작, 요청이 끝날 때 트랜잭션 종료
		- 지연 트랜잭션(late transaction)
			- 트랜잭션 밖에서 모든 읽기 수행, 업데이트 시작시 트랜잭션 오픈
			- 트랜잭션에 소비되는 시간을 최소화
			- 일관성 없는 읽기 문제가 발생하므로 충돌이 심하거나 비즈니스 트랜잭션이 여러 요청에 걸치기때문에 어쩔수 없이 사용하는 경우가 아니라면 잘 사용X
	- 비즈니스 트랜잭션
		- 사용자에게 의미 있는 트랜잭션
			- 로그인, 계정 선택, 조회, 쓰기 또는 수정을 모두 포함하는 트랜잭션
		- 이 역시 시스템 트랜잭션과 마찬가지로 ACID 속성을 제공해야 함
			- 확실한 방법: 한 비즈니스 트랜잭션을 한 시스템 트랜잭션 안에서 실행
				- 긴 트랜잭션이 되는데 이는 사용하기 어렵다
			- 비즈니스 트랜잭션을 짧은 트랜잭션으로 분리
				- ACID 특성을 개발자가 직접 담당
				- 오프라인 동시성 문제를 해결해야 함

| 격리 수준        | 더티 읽기 | 반복 불가능 읽기 | 팬텀 |
| ---------------- | --------- | ---------------- | ---- |
| Read Uncommitted | O         | O                | O    |
| Read Committed   | X         | O                | O    |
| Repeatable Read  | X         | X                | O    |
| Serializable     | X         | X                | X    | 
