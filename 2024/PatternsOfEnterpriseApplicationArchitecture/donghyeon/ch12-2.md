## ch12. 객체-관계형 구조 패턴

## 논의

책에서는 '하위 클래스 한두 개에는 구현 테이블 상속을, 나머지에는 단일 테이블 상속을 사용할 수 있다.'라고 했습니다.

단일 테이블 상속, 클래스 테이블 상속, 구현 테이블 상속 중 하나를 선택할 때 자신만의 기준이 있으신가요?

제가 겪은 사례에서는 서로 공유하는 속성이 많아서 단일 테이블 상속 패턴을 적용했었습니다.

## 내용

- 의존 매핑(Dependent Mapping)
    - 한 클래스(의존자)가 자신의 DB 지속성을 위해 다른 클래스(소유자)에 의존
    - 의존자와 소유자는 1:1 매핑
    - 대부분 소유자를 로드하면 의존자도 함께 로드되므로 지연 로드 사용을 고려
    - 의존자는 식별자 필드를 갖지 않음 -> 식별자 맵에 저장되지 않음
- 포함 값(Embedded Value)
    - 객체의 값을 소유자의 레코드에 있는 필드로 매핑(값 객체)
- 직렬화 LOB(Serialized LOB)
    - 고려해야 할 사항
        - 식별자 문제
            - 고객 LOB를 주문 테이블에 넣으면 고객 데이터가 모든 주문에 복사됨
            - 주문할 당시의 고객 데이터의 스냅샷을 저장하면 임시 관계 문제가 방지되고 좋음
        - 데이터 복제 문제
            - 직렬화 LOB 전체가 복제되는 경우보다는 다른 항목과 겹치는 부분이 복제되는 경우가 많음
    - LOB은 SQL로 쿼리할 가능성이 거의 없는 객체를 애플리케이션 바깥으로 분리하는 방법이라고 생각하자
- 단일 테이블 상속(Single Table Inheritance)
    - 모든 클래스의 모든 필드를 단일 테이플로 매핑
    - 장점
        - 한 테이블만 사용 -> 조인할 필요가 없음
        - 필드의 계층을 이동시켜도 DB를 변경할 필요가 없음
    - 단점
        - 테이블의 컬럼이 객체와 연관이 없을 수도 있음 -> 개발자의 혼란
        - DB 공간의 낭비
        - 단일 테이블이 여러 인덱스를 포함해 지나치게 커지고 빈번한 잠금, 성능 저하
            - 예방법: 특정 속성을 가진 행의 키를 나열하거나 별도의 인덱스 테이블 사용
        - 중복되는 컬럼 이름이 존재할 수 있음
- 클래스 테이블 상속(Class Table Inheritance)
    - 도메인 모델의 클래스당 하나의 테이블을 사용
    - 도메인 클래스의 각 필드는 해당 테이블의 컬럼과 일대일로 대응
    - 장점
        - 테이블 구조를 이해하기 쉽고 공간이 낭비되지 않음
        - 도메인 모델과 DB 간의 관계가 직관적
    - 단점
        - 객체 하나를 읽기 위해 조인을 하거나 여러 번의 쿼리 실행이 필요
        - 필드의 계층을 이동시키면 DB도 변경되어야 함
        - 상위 테이블에서 병목현상이 발생할 수 있음
        - 정규화 수준이 높아서 임시 쿼리(ad hoc query)가 이해하기 어려워짐
- 구현 테이블 상속(Concrete Table Inheritance)
    - 구현 클래스당 테이블 하나를 사용
    - 기본 키는 해당 테이블 뿐아니라 관련된 모든 테이블에서 유일해야 함
    - 장점
        - 각 테이블이 독립적이며 무의미한 필드가 없음
        - 객체를 읽을 때 조인할 필요가 없음
        - 테이블 접근에 대한 접근 부하를 분산할 수 있음
    - 단점
        - 기본 키 처리의 어려움
        - 추상 클래스에 대한 DB 관계를 강제할 수 없음
        - 필드의 계층을 이동시키면 클래스 테이블 상속만큼은 아니지만 DB 변경이 필요
        - 상위 클래스의 필드가 변경되면 모든 테이블을 변경
        - 상위 클래스에서 검색하려면 모든 테이블을 확인해야하므로 많은 조인이나 쿼리 실행이 필요
- 상속 매퍼(Inheritance Mapper)
    - 계층과 함께 매퍼를 구성해 도메인 클래스별로 매퍼를 구성하여 데이터 저장 및 로드
