### 데이터베이스 세션 상태

> 세션 데이터를 데이터베이스에 커밋된 데이터로 저장한다.

#### 작동 원리

서버 객체가 데이터베이스에서 데이터를 가져오려면 세션에 대한 정보가 필요하므로
세션 ID를 클라이언트에 저장해야 한다.
이는 데이터베이스에서 적절한 양의 데이터를 찾는 데 필요한 키 집합이다.

고려해야 하는 상항으로 세션이 커밋되 기전에 시스템의 다른 부분에 영향을 미치지 않아야 한다.
한 세션 내에서 주문을 처리할 때 주문의 중간 상태를 데이터베이스에 저장하려면
세션이 완료된 후 확정된 주문을 저장할 때와 다른 방식으로 처리해야 한다.

세션 데이터의 분리 방법 중 하나로 세션 데이터를 포함하는 데이터베이스 행에 필드 하나를 추가하는 것으로
부울 isPending 필드를 사용하는 것이다.
하지만 세션 ID를 보류 필드에 저장하려면 특정 세션의 모든 데이터를 훨씬 쉽게 찾을 수 있다.

세션 ID 필드를 사용하는 방법은 세션 데이터를 가져오지 않기 위해 이 필드의 의미를 알아야 한다는 면에서 변화를 요구하는 해결책이다.
뷰를 사용하면 변경 요건을 완화할 수 있지만 뷰를 사용하는 비용이 따른다.

두 번째 대안으로 보류 테이블(pending table)을 별도로 만드는 것이다.
이 방법으로 변경 요건을 크게 완화할 수 있다.
그러나 테이블 선택 논리를 추가한다는 점에서 작업의 부담은 늘어난다.

레코드 데이터는 무결성 규칙이 적용되어 있으므로 필요에 따라 보류 테이블에 규칙을 적용할 수 있다.
일반적으로 보류 데이터를 저장할 때는 유효성 검사 규칙이 적용되지 않는다.

보류 테이블은 실제 테이블과 복제본이어야 매핑 논리를 유지할 수 있다.
두 테이블의 필드명을 동일하게 지정하고 보류 테이블에 세션 ID 필드를 추가해 세션의 모든 데이터를 쉽게 검색할 수 있게 한다.

세션이 취소 또는 중단된 경우 세션 데이터를 삭제하는 매커니즘이 필요하다.
사용자가 세션을 중단하면 시간 제한 매커니즘을 둔다.
몇 분마다 실행되는 데몬으로 오래된 세션 데이터를 삭제한다.
이를 위해 데이터베이스의 테이블에 세션과 마지막 상호작용을 수행한 시간을 기록해야 한다.

업데이트를 허용하면 롤백이 복잡해지는 문제가 있다.
기존 레코드 데이터에 대한 모든 업데이트는 요청이 완료된 후 레코드 데이터의 일부가 되게 세션 취소를 허용하지 않는다.
수정될 수 있는 데이터를 보류 테이블로 복사하고 수정한 다음에 세션이 완료되면 레코드 테이블로 커밋하는 방식으로 한다.
보류 필드로도 가능하지만 세션 ID가 키의 일부인 경우에만 가능하다.
같은 테이블에 동시에 이전 ID와 새로운 ID가 모두 포함될 수 있으므로 복잡해진다.

세션을 처리하는 객체에서만 별도의 보류 테이블을 사용한다면 데이터를 테이블 형식으로 만들 이유가 없다.
이 때는 `직렬화 LOB`를 사용한다. 이 시점에 서버 세션 상태로 경계를 넘은 것이다.

보류 데이터를 사용하지 않으면 보류 데이터와 관련된 복잡한 문제를 생각할 필요가 없다.
그러면 모든 데이터가 레코드 데이터로 취급되도록 시스템을 설계하는 것이다.
이 방법을 선택하면 데이터베이스 세션 상태를 쉽게 처리할 수 있다.

#### 사용 시점

데이터베이스 세션 상태는 세션 상태를 처리하기 위한 대안이며
`서버 세션 상태` 및 `클라이언트 세션 상태`와 비교해야 한다.

이 패턴에서 고려할 첫 번째 측면은 성능이다.
서버에서 상태 비저장 객체를 사용해 풀링과 클러스터링이 지원되므로 성능상 이익이다.
요청마다 데이터베이스와 데이터를 주고 받는 데 시간이 걸리지만 캐시가 적중하면 데이터베이스에서 데이터를 읽을 필요가 없으므로 비용을 낮출 수 있다.
하지만 쓰기 비용은 그대로 필요하다.

두 번째 측면은 세션 상태를 처리하는 작업과 관련된 프로그래밍 노력에 대한 것이다.
세션 상태 없이 모든 데이터를 레코드 데이터로 저장한다면 프로그래밍 노력이나 성능 면에서 손해가 없으므로
이 패턴이 최선의 방법이다.

데이터베이스 세션 상태와 `서버 세션 상태` 중에서 선택한다면 클러스터링과 장애 조치를 사용하기가 얼마나 수월한지를 파악해야 한다.
데이터베이스 세션 상태를 쓴다면 일반적인 해결책에서는 클러스터링과 장애 조치가 더 직관적이다.