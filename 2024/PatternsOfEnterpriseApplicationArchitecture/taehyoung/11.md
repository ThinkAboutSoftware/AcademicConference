# 11장 객체-관계형 동작 패턴

# 논의 내용

1. 작업 단위 내용을 보면, 낙관적, 비관적 잠금을 사용해서 복잡하게 비즈니스 트랜잭션을 관리하기 위한 안정적인 플랫폼 이라는 말이 나옵니다. 작업단위를 수행하는 부분의 코드에서만 명시적으로 데이터베이스의 커밋이 이루어지기 때문에, 문제가 발생했을 때, 디버깅이 훨씬 쉬울 것 같다는 생각이 들었습니다. 다른 분들의 의견은 어떠신가요?

# 내용 & 내 생각

## 작업 단위

- 비즈니스 트랜잭션의 영향을 받은 객체의 리스트를 유지관리하고, 변경 내용을 기록하는 일과 동시성 문제를 해결하는 일을 조율한다.
- 처음 작업 단위(Unit of Work)에 대해서, 이 책 맨 앞부분을 읽고나서 이 패턴은 DB를 좀 더 효율적으로 사용하기 위해서, 어떤 변경사항을 한번에 모아서 처리하려는 의도라고 생각을 하였다
- 작업 단위 패턴은 일관되고 효율적인 방식으로 데이터베이스 변경사항을 관리하는데 중점을 둔다.
- 작업 단위는 비즈니스 트랜잭션 중에 발생하는 모든 변경사항을 추적한다. 그리고 이 변경사항들을 마지막 순간에 커밋을 해서 데이터베이스에 반영시키는데, 이것을 통해서 데이터베이스 호출을 감소 시킬 수 있고, 트랜잭션 관리를 단순화 시킬 수 있다
- 작업 단위의 가장 중요한 장점은 작업 단위가 모든 정보를 한곳에 모은다는 것이다. 작업 단위가 작동할 수 있게 준비를 완료한 후에는 별다른 일을 하지 않아도 변경 내용을 추적할 수 있다.
- 작업 단위는 낙관적 오프라인 잠금과 비관적 오프라인 잠금을 사용해 여러 시스템 트랜잭션에 걸친 비즈니스 트랜잭션을 처리하는 것과 같은 더 복잡한 상황을 관리하기 위한 안정적인 플랫폼이다

## 식별자 맵

- 모든 객체를 한 맵에 로드해 각 객체가 한 번씩만 로드되게 한다. 객체를 참조할 때는 맵을 이용해 객체를 조회 한다
- 객체에 대한 요청이 이루어지면 식별자 맵은 객체가 이미 메모리에 로드되었는지 확인하고, 그렇다면, 데이터베이스를 다시 쿼리하는 대신 메모리 내 개체를 반환한다
- 식별자 맵은 단일 비즈니스 트랜잭션이 데이터베이스에서 읽은 모든 객체에 대한 기록을 보관한다
- 단일 맵의 장점은 데이터베이스 테이블을 추가할 때 맵을 추가하지 않아도 된다는 것이다.
- 일반적으로 식별자 맵은 데이터베이스에서 가져오고 수정하는 객체를 관리하는데 사용한다. 객체를 관리하는 이유는 인메모리 객체 두 개가 동일한 데이터베이스 레코드와 연결되는 상황을 방지하기 위해서다.
- 읽기 전용 객체에 대해서는 식별자 맵이 필요 없을 수 있다. 그 이유는 객체를 변경할 수 없으면 객체 수정에 의한 문제를 걱정할 필요가 없기 때문이다

## 지연 로드

- 필요한 데이터를 모두 포함하지는 않지만 데이터가 필요할 때 가져오는 방법을 아는 객체
- 지연 로드의 다른 위험성은 데이터베이스 접근이 필요 이상으로 늘어날 수 있다는 것이다. 이 현상을 물결 로딩(ripple loading)이라고 한다. 이와 비슷한 현상을 django에서도 찾아볼 수 있는데, N+1 문제와도 비슷한 문제로 보인다
- 성능 관점에서 지연 로드는 데이터를 가져오는 비용을 언제 지불할지 결정하는 것에 해당한다