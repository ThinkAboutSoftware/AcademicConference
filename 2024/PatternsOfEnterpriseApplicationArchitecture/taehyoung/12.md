# 12장 객체-관계형 구조 패턴

# 논의 내용

- 제가 사용했던 django 프레임워크의 경우엔 데이터베이스와 매핑되는 객체모델을 정의할 때, pk를 명시적으로 지정해주지 않으면 자동적으로 auto increment 하는 id 값을 생성하는 식으로 되어있어서, 의미 있는 키를 pk로 지정해서 사용해본적은 거의 없습니다 예전에 핸드폰 번호를 pk로 써보려는 시도를 해보려고 생각해본적은 있는데, 한 사람이 여러 핸드폰 번호를 가진 경우도 있다면(라이더들의 경우는 꽤나 많음), 제대로 식별자 역할을 할 수가 없습니다 이와 관련된 다른 분들의 경험이 있다면 궁금 합니다
- 책에서 제시한 단일, 클래스, 구현과 관련해서, 본인이 주로 설계하는 방식은 어떤 것인가요? 책에서는 객체의 상속구조를 기반으로 이를 테이블에 어떻게 끼워맞출지를 고민하는데, 저는 주로 반대로 정규화를 기준으로 테이블 설계를 먼저 많이 했던 것 같고 그 과정에서 의도치않게 책에서 제시한 단일, 클래스, 구현이 조금씩 다 섞어서 썼던것 같습니다 다른 분들은 경험이 따로 있으실지 궁금합니다

# 식별자 필드

- 인메모리 객체와 데이터베이스 행 간의 식별자를 유지 관리하기 위해 데이터베이스 ID 필드를 저장하는 객체
- 식별자 필드는 관계형 데이터베이스의 기본 키를 객체의 필드에 저장하는 것이 전부다
- 키는 의미 있는 키와 의미 없는 키 사이에서 선택할 수 있는데, 주민등록번호, 강의번호와 같은 의미 있는 키가 실용적으로 보일 수 있지만, 잠재적인 데이터 무결성 문제가 발생할 수 있기 때문에, 의미 없는 키를 사용하여서 더 높은 신뢰성과 데이터베이스 무결성을 보장하게 된다. 개인적으로는 RDB 설계 시, 가능하면 의미 없는 키로 ID 값을 만들려고 하는데 그 이유는 모든 테이블을 의미 없는 키로 통일해서 쓴다고 했을 때, 키에 대한 예외가 없어서 인지하기 쉬웠기 때문이다
- 키 유형의 경우는 단순 키 혹은 복합 키에 대한 결정이 중요하고,테이블 내에서 고유한지 여부가 중요하다
- 키 생성의 경우 나는 기본적으로 자동 생성 방법을 가장 많이 사용한다
- 인 메모리 객체와 데이터베이스 행 간의 매핑이 있을 때 사용한다

# 외래 키 매핑

- 데이터베이스의 외래 키에 해당하는 개체의 ID 필드를 사용하여 데이터베이스에 저장하고, 데이터베이스에서 로드할 때 개체 관계를 보존한다
- 이 패턴을 사용하면 객체 지향 프로그래밍과 관계형 데이터베이스의 데이터 구조가 일치하지 않음에도 불구하고 객체 지향 모델을 관계형 데이터베이스 제약 조건 내에서 효율적으로 저장하고 관리할 수 있다.
- 흔히, django나 sql alchemy 같은 ORM 을 사용할 때, 자주 볼 수 있는데, 객체 참조를 테이블의 외래키를 통해서 매핑 할 수 있다
- 외래 키 매핑은 대부분의 클래스 간 연결에 사용할 수 있는데, 적용할 수 없는 가장 일반적인 경우는 다대다 연결이다. 제 1정규형에서는 단일 필드에 여러 외래 키를 저장할 수 없다고 규정하기 때문이다. 다대다 연결을 위해선 연관 테이블 매핑을 사용 해야한다

# 연관 테이블 매핑

- 객체는 컬렉션을 필드 값으로 사용해 다중 값 필드를 쉽게 처리할 수 있지만 관계형 데이터베이스에서는 단일 값 필드만 사용할 수 있다 특히, 다대다 연관의 경우는 외래 키를 포함할 단일 값 쪽이 없기 때문이다. 이때, 관계형 데이터베이스에서의 해결책은 관계를 기록하는 추가 테이블을 만드는 것이다 그후, 연관 테이블 매핑을 사용해 다중 값을 링크 테이블로 매핑하면 된다
- 링크 테이블에서 데이터를 로드 하려면 쿼리를 두번해야하는데, 매핑 테이블을 먼저 쿼리해서 ID값을 가져온 후, 그 ID를 기준으로 다른 테이블을 조회하는 것이다. 이는 쿼리를 불필요하게 사용할 수 있기 때문에, 조인을 통해서 단일 쿼리로 변경할 수 있다
- 연관 테이블 매핑의 표준적인 용도는 다대다 연관 관계를 나태내는 것이다

# 식별자 필드

- 인메모리 객체와 데이터베이스 행 간의 식별자를 유지 관리하기 위해 데이터베이스 ID 필드를 저장하는 객체
- 식별자 필드는 관계형 데이터베이스의 기본 키를 객체의 필드에 저장하는 것이 전부다
- 키는 의미 있는 키와 의미 없는 키 사이에서 선택할 수 있는데, 주민등록번호, 강의번호와 같은 의미 있는 키가 실용적으로 보일 수 있지만, 잠재적인 데이터 무결성 문제가 발생할 수 있기 때문에, 의미 없는 키를 사용하여서 더 높은 신뢰성과 데이터베이스 무결성을 보장하게 된다. 개인적으로는 RDB 설계 시, 가능하면 의미 없는 키로 ID 값을 만들려고 하는데 그 이유는 모든 테이블을 의미 없는 키로 통일해서 쓴다고 했을 때, 키에 대한 예외가 없어서 인지하기 쉬웠기 때문이다
- 키 유형의 경우는 단순 키 혹은 복합 키에 대한 결정이 중요하고,테이블 내에서 고유한지 여부가 중요하다
- 키 생성의 경우 나는 기본적으로 자동 생성 방법을 가장 많이 사용한다
- 인 메모리 객체와 데이터베이스 행 간의 매핑이 있을 때 사용한다

# 외래 키 매핑

- 데이터베이스의 외래 키에 해당하는 개체의 ID 필드를 사용하여 데이터베이스에 저장하고, 데이터베이스에서 로드할 때 개체 관계를 보존한다
- 이 패턴을 사용하면 객체 지향 프로그래밍과 관계형 데이터베이스의 데이터 구조가 일치하지 않음에도 불구하고 객체 지향 모델을 관계형 데이터베이스 제약 조건 내에서 효율적으로 저장하고 관리할 수 있다.
- 흔히, django나 sql alchemy 같은 ORM 을 사용할 때, 자주 볼 수 있는데, 객체 참조를 테이블의 외래키를 통해서 매핑 할 수 있다
- 외래 키 매핑은 대부분의 클래스 간 연결에 사용할 수 있는데, 적용할 수 없는 가장 일반적인 경우는 다대다 연결이다. 제 1정규형에서는 단일 필드에 여러 외래 키를 저장할 수 없다고 규정하기 때문이다. 다대다 연결을 위해선 연관 테이블 매핑을 사용 해야한다

# 연관 테이블 매핑

- 객체는 컬렉션을 필드 값으로 사용해 다중 값 필드를 쉽게 처리할 수 있지만 관계형 데이터베이스에서는 단일 값 필드만 사용할 수 있다 특히, 다대다 연관의 경우는 외래 키를 포함할 단일 값 쪽이 없기 때문이다. 이때, 관계형 데이터베이스에서의 해결책은 관계를 기록하는 추가 테이블을 만드는 것이다 그후, 연관 테이블 매핑을 사용해 다중 값을 링크 테이블로 매핑하면 된다
- 링크 테이블에서 데이터를 로드 하려면 쿼리를 두번해야하는데, 매핑 테이블을 먼저 쿼리해서 ID값을 가져온 후, 그 ID를 기준으로 다른 테이블을 조회하는 것이다. 이는 쿼리를 불필요하게 사용할 수 있기 때문에, 조인을 통해서 단일 쿼리로 변경할 수 있다
- 연관 테이블 매핑의 표준적인 용도는 다대다 연관 관계를 나태내는 것이다

# 의존 매핑

- 의존 매핑의 기본 개념은 한 클래스가 자신의 데이터베이스 지속성을 위해 다른 클래스에 의존한다는 것이다.
- 의존 매핑은 객체를 참조하는 객체가 하나일 때만 사용하며, 보통은 한 객체가 의존자의 컬렉션을 가지는 경우가 많다. 의존 매핑은 소유자가 의존자 참조의 컬렉션을 가지지만 역참조가 없는 불편한 상황을 해결하기에 좋은 방법이다
- 이 의존 매핑 기능은 SQL Alchemy의 relationships 와 비슷한 개념으로 이해 되었다

# 포함 값

- 포함 값은 객체의 값을 객체 소유자의 레코드에 있는 필드로 매핑한다
- 일반적으로 포함 값은 참조 객체 간의 연관 관계에서 양쪽 끝이 모두 단일 값일 때 사용한다.
- 포함 값에 대한 설명은 파이썬 데이터 파싱 및 validation 라이브러리인 pydantic 사용사례와도 비슷한 것 처럼 보였다

# 직렬화 LOB

- 객체 모델을 사용하면 조직 계층을 나타내는 구성 요소 패턴을 아주 자연스럽게 보여줄 수 있지만, 관계형 스키마로는 이런 구조를 표현하기 어렵다
- 객체를 지속하는 다른 방법으로 객체 그래프 전체를 한 테이블의 큰 객체 하나에 기록하는 직렬화가 있다
- 이 직렬화는 RDB 에서 제공하는 JsonField 와 비슷한 맥락으로 보인다

# 단일 테이블 상속

- 관계형 데이터베이스는 상속을 지원하지 않으므로, 객체를 데이터베이스로 매핑할 때는 상속 구조를 관계형 테이블에서 나타내는 방법을 고려 해야한다
- 이 상속 매핑 체계에서는 상속 계층에 속한 모든 클래스의 데이터를 모두 한 테이블에 저장한다
- 단일 테이블 상속의 장점과 단점
    - 장점
        - 한 테이블에서 관리 가능하다
        - 조인이 필요 없다
    - 단점
        - 일부 하위 클래스에만 사용되는 열이 있으면, 데이터베이스의 공간이 낭비된다(null) 이는 관계형 설계를 깨버리게 된다
        - 인덱스가 추가되는데, 테이블이 커지고, 양이 많아지면 성능저하가 발생할 수 있다

# 클래스 테이블 상속

- 객체-관계형에서 가장 현저하게 드러나는 불일치는 관계형 데이터베이스가 상속을 지원하지 않는 다는 점이다. 이때, 상속 구조의 클래스마다 데이터베이스 테이블 하나를 매칭해서 사용할 수있다
- 클래스 테이블 상속의 장점과 단점
    - 장점
        - 각 행의 모든 열에 의미가 있으므로 테이블의 구조를 이해하기 쉽고 공간이 낭비되지 않는다
    - 단점
        - 객체 하나를 로드하기 위해 여러 테이블에서 데이터를 읽어야 하고, 즉, 조인이나 여러 번의 쿼리로 읽은 데이터를 메모리에서 결합해야하고, 이 과정에서 성능에 문제가 발생할 수있음

# 구현 테이블 상속

- 상속 계층에 포함된 각 구현 클래스마다 테이블 하나를 사용해서 구성된다
- 이 패턴을 사용할 때는 키에 주의 해야한다
- 구체적인 클래스당 하나의 테이블을 생성하여 상속 계층 구조를 데이터베이스에 매핑하는 전략
- 구현 테이블 상속의 장점과 단점
    - 장점
        - 각 테이블이 독립적이며 무의미한 필드가 없게 된다
    - 단점
        - 상위 클래스 필드가 변경되면 이 필드가 있는 테이블을 모두 변경해야 한다
            - 예제를 기준으로는 이름이 삭제되게 되면 하위 테이블에서 모두 영향을 받는다

# 상속 매퍼

- 상속 계층을 처리하는 데이터베이스 매퍼를 구성하는 구조이다
- 계층과 함께 매퍼를 구성해 도메인 클래스별 매퍼를 통해 해당 도메인 클래스의 데이터를 저장하고 로드할 수 있다