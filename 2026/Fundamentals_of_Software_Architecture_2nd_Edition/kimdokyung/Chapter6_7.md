# Chapter 06: 운영 데이터 분리

이번 챕터는 데이터베이스 분해에 대한 내용이다. 서비스를 아무리 잘 나눠놔도 DB가 하나로 붙어있으면 진짜 분리가 아니라는 점을 계속 강조한다.

책에서 데이터 아키텍처가 "왜 굳이 DB를 나눠야 하는데?"라고 버티는 장면이 인상 깊었다. 찾아보니까 실무에서도 DB 분리에 대한 저항이 제일 크다고 한다. 코드는 롤백이라도 하면 되는데, 데이터는 한번 꼬이면 복구가 어렵기 때문이라고.

DB를 나눠야 하는 이유로 변경 관리, 커넥션 관리, 확장성, 내고장성 같은 것들이 나오는데, 결국 핵심은 "장애 격리"와 "독립적 변경"이라고 이해했다. 스키마 바꿨는데 어떤 서비스가 터질지 모르는 상황, 서비스들이 DB 하나 바라보면서 커넥션 풀이 바닥나는 상황, DB 하나 죽으면 전체가 다 죽는 상황. 이런 걸 피하려면 DB도 나눠야 한다. 근데 지난 토론 때 다른 분들이 아키텍처 분해는 보통 운영 중 문제가 발생했을 때 진행한다고 하셨는데, DB 분해도 마찬가지인지 궁금해서 찾아봤다. 역시 대부분 운영 중에 문제가 터지고 나서야 진행한다고 한다. 처음부터 완벽하게 나누기보다는 모놀리스로 시작해서 필요할 때 분리하는 게 현실적이라는 얘기도 있었다.

반대로 합쳐야 하는 이유도 있다. 외래 키로 엮여 있거나 조인이 필수인 테이블들은 분리하면 오히려 복잡해진다. ACID가 필요한 상황에서 억지로 나누면 Saga 같은 보상 로직이 필요해지는데, 찾아보니까 이게 구현하기 꽤 까다롭다고 한다.

5단계 분해 프로세스가 나오는데, 도메인 정의 → 테이블 할당 → 커넥션 분리 → 스키마 이전 → 독립 운영 순서다. 동의어(별칭)를 활용해서 점진적으로 마이그레이션하는 팁이 나오는데, 한번에 다 바꾸는 게 아니라 별칭으로 연결해두고 서비스 하나씩 옮기는 방식이라고 한다.

설문 데이터를 RDB에서 문서형 DB로 옮기는 사례도 나온다. UI에서 설문 렌더링하기가 편해지고 변경 요청 대응이 빨라진다는 게 비즈니스 정당성이었다. 단일 애그리거트(질문을 설문 안에 임베딩)와 분할 애그리거트(질문을 별도 문서로) 중에서 팀이 단일 애그리거트를 선택하는데, 중복이 생기지만 UI 렌더링이 단순해지는 트레이드오프를 받아들인 것이다.

# Chapter 07: 서비스 세분도

이 챕터의 핵심은 "감으로 하지 말고 분해인/통합인을 분석해서 판단하라"는 것이다.

모듈화와 세분도를 구분하는 부분이 있다. 모듈화는 시스템을 나누는 것이고, 세분도는 나눈 조각의 크기다. 분산 시스템에서 진짜 어려운 건 "나눌지 말지"가 아니라 "얼마나 잘게 나눌지"라는 말이 와닿았다.

분해인(나눠야 하는 이유)으로 서비스 범위, 코드 변동성, 처리량, 내고장성, 보안, 신장성이 나온다. 책의 예시를 내 나름대로 적용해봤는데, 결제 서비스를 생각해보면 카드/계좌이체/간편결제가 모두 "결제"니까 응집도는 높다. 이것만으로는 분리 근거가 부족하다. 그런데 변동성을 보면 카드/계좌이체는 거의 안 바뀌는데 간편결제는 새로운 PG사 연동 때문에 자주 바뀔 것 같다. 처리량도 카드가 압도적으로 많고 계좌이체는 상대적으로 적을 것 같다. 이런 차이가 크면 분리하는 게 맞다고 이해했다.

통합인(합쳐야 하는 이유)도 중요하다. 이것도 내 나름대로 생각해봤는데, 주문과 재고를 나눴다고 치면 주문 생성 시 재고 차감도 같이 해야 한다. 하나 실패하면 주문은 됐는데 재고는 안 빠지는 상황이 생길 수 있다. 서비스들이 줄줄이 호출되면 하나 죽으면 전체가 멈추고, 호출마다 지연이 쌓인다. 분해인만 보면 다 쪼개고 싶어지는데, 통합인도 같이 봐야 한다는 점이 인상 깊었다.

서비스 이름으로 응집도를 테스트하는 팁이 재밌었다. 결제 서비스에 대입해보면, 카드 결제 서비스 + 기타 결제 서비스? 별로다. 카드 결제 서비스 + 계좌이체 서비스 + 간편결제 서비스? 이건 괜찮다. 이름이 어색하면 응집도가 깨진 거다.

# 논의 주제

- 서비스나 DB를 나눌 때 분해인/통합인을 실제로 정량화해서 판단해본 경험이 있으신가요? 있다면, 결국 이런 결정은 팀이나 사내에서 하게 될 텐데 각자 다른 생각을 가지고 있을 것 같습니다. 각자 주장이 맞다고 내세울 때 어떤 근거들을 들고, 그 근거들은 어떤 방식으로 가져오시는지 궁금합니다.
  > 저는 팀 프로젝트에서 API 분리할 때 대부분 감으로 결정했던 것 같아서, 이런 상황에서 어떻게 합의를 이끌어내는지 경험을 들어보고 싶습니다.
